name: Auto Merge Fabric to Prod.

on:
  push:
    branches:
      - fabric

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com

      - name: Fetch latest changes
        run: |
          git fetch origin PROD

      - name: Merge fabric into PROD
        run: |
          git checkout PROD
          git merge --no-ff origin/fabric -m "Auto-merge fabric into PROD" || true
          git status

      - name: Check for conflicts
        id: check_conflicts
        run: |
          if git diff --name-only --diff-filter=U | grep . > /dev/null; then
            echo "has_conflicts=true" >> $GITHUB_OUTPUT
          else
            echo "has_conflicts=false" >> $GITHUB_OUTPUT
          fi

      - name: Resolve conflicts (if any)
        if: steps.check_conflicts.outputs.has_conflicts == 'true'
        run: |
          conflicting_files=$(git diff --name-only --diff-filter=U)
          echo "Conflicting files: $conflicting_files"
          for file in $conflicting_files; do
            if [ -f "$file" ]; then
              git checkout --theirs "$file"
              git add "$file"
            else
              git rm "$file"
            fi
          done
          git commit -m "Resolve conflicts: keep changes from fabric"

      - name: Push changes
        run: git push origin PROD
